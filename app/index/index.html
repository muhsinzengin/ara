<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CanlÄ± Destek</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      overflow: hidden;
    }
    
    .container { 
      display: flex; 
      flex-direction: column; 
      height: 100vh; 
      position: relative;
    }
    
    .header {
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px;
      text-align: center;
      backdrop-filter: blur(10px);
    }
    
    .header h1 { font-size: 24px; margin-bottom: 5px; }
    .header p { opacity: 0.8; font-size: 14px; }
    
    .video-container {
      flex: 1;
      position: relative;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .local-video {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 200px;
      height: 150px;
      border-radius: 10px;
      border: 3px solid #4CAF50;
      z-index: 10;
    }
    
    .remote-video {
      width: 100%;
      height: 100%;
    }
    
    .controls {
      background: rgba(0,0,0,0.9);
      padding: 20px;
      display: flex;
      justify-content: center;
      gap: 15px;
      backdrop-filter: blur(10px);
    }
    
    .control-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: #333;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    .control-btn:hover { background: #555; transform: scale(1.1); }
    .control-btn.off { background: #f44336; }
    .control-btn.active { background: #4CAF50; }
    
    .welcome-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      color: white;
      text-align: center;
    }
    
    .welcome-screen h2 { font-size: 32px; margin-bottom: 20px; }
    .welcome-screen p { font-size: 18px; margin-bottom: 30px; opacity: 0.8; }
    
    .name-input {
      padding: 15px 20px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      color: white;
      width: 300px;
      text-align: center;
      backdrop-filter: blur(10px);
    }
    
    .name-input::placeholder { color: rgba(255,255,255,0.5); }
    
    .start-btn {
      margin-top: 20px;
      padding: 15px 40px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      background: #4CAF50;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .start-btn:hover { background: #45a049; transform: scale(1.05); }
    .start-btn:disabled { background: #666; cursor: not-allowed; transform: none; }
    
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 200;
      color: white;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #333;
      border-top: 5px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .status-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 18px;
      z-index: 50;
    }
    
    .timer {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 16px;
      z-index: 50;
    }
    
    .hidden { display: none !important; }
    
    @media (max-width: 768px) {
      .local-video { width: 120px; height: 90px; top: 10px; right: 10px; }
      .control-btn { width: 50px; height: 50px; font-size: 16px; }
      .name-input { width: 250px; }
      .welcome-screen h2 { font-size: 24px; }
      .welcome-screen p { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸŽ¥ CanlÄ± Destek</h1>
      <p>MÃ¼ÅŸteri hizmetleri ile gÃ¶rÃ¼ntÃ¼lÃ¼ konuÅŸma</p>
    </div>
    
    <div class="video-container">
      <video id="remoteVideo" class="remote-video" autoplay muted></video>
      <video id="localVideo" class="local-video" autoplay muted></video>
      
      <div id="statusText" class="status-text">BaÄŸlanÄ±yor...</div>
      <div id="timer" class="timer hidden">00:00</div>
    </div>
    
    <div class="controls">
      <button id="micBtn" class="control-btn" data-label="Mikrofon">ðŸŽ¤</button>
      <button id="videoBtn" class="control-btn" data-label="Kamera">ðŸ“¹</button>
      <button id="speakerBtn" class="control-btn" data-label="HoparlÃ¶r">ðŸ”Š</button>
      <button id="proximityBtn" class="control-btn" data-label="Ahize Modu">ðŸ“±</button>
      <button id="fullscreenBtn" class="control-btn" data-label="Tam Ekran">â›¶</button>
      <button id="endBtn" class="control-btn" data-label="Kapat">ðŸ“ž</button>
    </div>
  </div>

  <div id="welcomeScreen" class="welcome-screen">
    <h2>ðŸ‘‹ HoÅŸ Geldiniz!</h2>
    <p>Destek ekibimizle gÃ¶rÃ¼ntÃ¼lÃ¼ konuÅŸma yapmak iÃ§in adÄ±nÄ±zÄ± girin</p>
    <input id="nameInput" class="name-input" type="text" placeholder="AdÄ±nÄ±zÄ± girin..." maxlength="50">
    <button id="startBtn" class="start-btn" disabled>ðŸ“ž AramayÄ± BaÅŸlat</button>
  </div>

  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
    <div id="loadingText">BaÄŸlanÄ±yor...</div>
  </div>

  <audio id="remoteAudio" autoplay></audio>

  <!-- Enhanced Quality Systems Scripts -->
  <script src="/static/webrtc-config.js"></script>
  <script src="/static/common-utils.js"></script>
  <script src="/static/audio-processor.js"></script>
  <script src="/static/video-quality-manager.js"></script>
  <script src="/static/network-monitor.js"></script>
  <script src="/static/mobile-optimizer.js"></script>
  
  <!-- Enhanced Quality Systems Styles -->
  <link rel="stylesheet" href="/static/audio-level-styles.css">
  <link rel="stylesheet" href="/static/video-quality-styles.css">
  <link rel="stylesheet" href="/static/mobile-optimizer-styles.css">

  <script>
    // Customer Call - Optimized and Clean
    class CustomerCall {
      constructor() {
        this.callId = null;
        this.pc = null;
        this.localStream = null;
        this.customerName = '';
        this.callStartTime = null;
        this.timerInterval = null;
        this.proximityMode = false;
        this.init();
      }

      init() {
        const nameInput = CommonUtils.$('#nameInput');
        const startBtn = CommonUtils.$('#startBtn');
        
        if (!nameInput || !startBtn) {
          console.error('Required elements not found');
          return;
        }
        
        nameInput.oninput = (e) => {
          const value = e.target.value.trim();
          startBtn.disabled = value.length < 1;
          
          if (value.length >= 1) {
            startBtn.style.opacity = '1';
            startBtn.style.cursor = 'pointer';
          } else {
            startBtn.style.opacity = '0.5';
            startBtn.style.cursor = 'not-allowed';
          }
        };
        
        nameInput.onkeypress = (e) => {
          if (e.key === 'Enter' && !startBtn.disabled) {
            this.startCall();
          }
        };
        
        startBtn.onclick = () => this.startCall();
        
        // Control buttons
        const micBtn = CommonUtils.$('#micBtn');
        const videoBtn = CommonUtils.$('#videoBtn');
        const speakerBtn = CommonUtils.$('#speakerBtn');
        const proximityBtn = CommonUtils.$('#proximityBtn');
        const fullscreenBtn = CommonUtils.$('#fullscreenBtn');
        const endBtn = CommonUtils.$('#endBtn');
        
        if (micBtn) micBtn.onclick = () => this.toggleMic();
        if (videoBtn) videoBtn.onclick = () => this.toggleVideo();
        if (speakerBtn) speakerBtn.onclick = () => this.toggleSpeaker();
        if (proximityBtn) proximityBtn.onclick = () => this.toggleProximity();
        if (fullscreenBtn) fullscreenBtn.onclick = () => this.toggleFullscreen();
        if (endBtn) endBtn.onclick = () => this.endCall();
      }

      async startCall() {
        const nameInput = CommonUtils.$('#nameInput');
        if (!nameInput) return;
        
        this.customerName = nameInput.value.trim();
        if (!this.customerName) return;

        this.showLoading('Kamera ve mikrofon eriÅŸimi isteniyor...');
        
        try {
          // Get optimal constraints
          const constraints = await this.getOptimalConstraints();
          this.localStream = await navigator.mediaDevices.getUserMedia(constraints);

          const localVideo = CommonUtils.$('#localVideo');
          if (localVideo) {
            localVideo.srcObject = this.localStream;
          }
          
          this.hideLoading();
          this.showCallScreen();
          await this.initWebRTC();
          
        } catch (err) {
          this.hideLoading();
          console.error('[CustomerCall] Media access error:', err);
          CommonUtils.Notifications.error('Kamera/mikrofon eriÅŸimi reddedildi');
        }
      }

      async getOptimalConstraints() {
        let constraints = {
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            sampleRate: 48000,
            channelCount: 1
          },
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            frameRate: { ideal: 30 }
          }
        };

        // Apply mobile optimizations if available
        if (window.mobileOptimizer) {
          const mobileConstraints = window.mobileOptimizer.getOptimalConstraints();
          constraints = { ...constraints, ...mobileConstraints };
        }

        return constraints;
      }

      async initWebRTC() {
        try {
          this.showLoading('BaÄŸlantÄ± kuruluyor...');
          
          const pcConfig = { 
            iceServers: this.getIceServers(),
            iceCandidatePoolSize: 10
          };
          this.pc = new RTCPeerConnection(pcConfig);

          this.localStream.getTracks().forEach(track => {
            this.pc.addTrack(track, this.localStream);
          });

          this.pc.ontrack = (event) => {
            const stream = event.streams[0];
            if (event.track.kind === 'video') {
              CommonUtils.$('#remoteVideo').srcObject = stream;
              CommonUtils.$('#statusText').textContent = 'BaÄŸlandÄ±';
            } else {
              const audio = CommonUtils.$('#remoteAudio');
              audio.srcObject = stream;
              audio.play().catch(e => console.log('Audio autoplay:', e));
            }
          };

          this.pc.onicecandidate = async (event) => {
            if (event.candidate) {
              await this.sendSignal('ice', { candidate: event.candidate });
            }
          };

          this.pc.onconnectionstatechange = () => {
            console.log('[CustomerCall] Connection state:', this.pc.connectionState);
            if (this.pc.connectionState === 'connected') {
              this.hideLoading();
              CommonUtils.Notifications.success('BaÄŸlantÄ± kuruldu!');
              this.startTimer();
              this.startQualityMonitoring();
            }
          };

          console.log('[CustomerCall] Creating offer...');
          const offer = await this.pc.createOffer({
            offerToReceiveAudio: true,
            offerToReceiveVideo: true
          });
          
          // Apply SDP optimizations
          let sdp = offer.sdp;
          if (typeof WebRTCHelpers !== 'undefined') {
            if (WebRTCHelpers.applyOpusSettings) {
              sdp = WebRTCHelpers.applyOpusSettings(sdp, {
                maxaveragebitrate: 128000,
                stereo: 1,
                useinbandfec: 1,
                usedtx: 1,
                maxplaybackrate: 48000
              });
            }
            
            if (WebRTCHelpers.preferCodec) {
              sdp = WebRTCHelpers.preferCodec(sdp, 'VP9', 'video');
            }
          }
          
          await this.pc.setLocalDescription({type: 'offer', sdp});
          await this.sendSignal('offer', {offer: {type: 'offer', sdp}});
          this.pollSignals();
          
        } catch (err) {
          this.hideLoading();
          console.error('[CustomerCall] WebRTC init error:', err);
          CommonUtils.Notifications.error('BaÄŸlantÄ± hatasÄ±');
        }
      }

      getIceServers() {
        if (typeof WebRTCConfig !== 'undefined') {
          return WebRTCConfig.iceServers;
        }
        
        return [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' },
          { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' }
        ];
      }

      async sendSignal(type, payload) {
        try {
          await fetch('/api/signal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type, callId: this.callId, ...payload })
          });
        } catch (err) {
          console.error('[CustomerCall] sendSignal error:', err);
        }
      }

      async pollSignals() {
        if (!this.callId || !this.pc) return;

        try {
          const res = await fetch('/api/poll-signal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ callId: this.callId })
          });
          const data = await res.json();

          if (data.success) {
            if (data.answer && !this.pc.currentRemoteDescription) {
              await this.pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            }

            if (data.ice_candidates && data.ice_candidates.length > 0) {
              for (const candidate of data.ice_candidates) {
                await this.pc.addIceCandidate(new RTCIceCandidate(candidate));
              }
            }
          }
        } catch (err) {
          console.error('[CustomerCall] Poll error:', err);
        }

        setTimeout(() => this.pollSignals(), 2000);
      }

      startQualityMonitoring() {
        if (window.networkMonitor && this.pc) {
          window.networkMonitor.startMonitoring(this.pc);
        }
      }

      toggleMic() {
        if (!this.localStream) return false;
        const track = this.localStream.getAudioTracks()[0];
        if (track) {
          track.enabled = !track.enabled;
          CommonUtils.$('#micBtn').classList.toggle('off', !track.enabled);
          return track.enabled;
        }
        return false;
      }

      toggleVideo() {
        if (!this.localStream) return false;
        const track = this.localStream.getVideoTracks()[0];
        if (track) {
          track.enabled = !track.enabled;
          CommonUtils.$('#videoBtn').classList.toggle('off', !track.enabled);
          return track.enabled;
        }
        return false;
      }

      toggleSpeaker() {
        const audio = CommonUtils.$('#remoteAudio');
        if (audio) {
          audio.muted = !audio.muted;
          CommonUtils.$('#speakerBtn').classList.toggle('off', audio.muted);
        }
      }

      toggleProximity() {
        this.proximityMode = !this.proximityMode;
        CommonUtils.$('#proximityBtn').classList.toggle('active', this.proximityMode);
        
        if (this.proximityMode) {
          CommonUtils.$('#videoBtn').classList.add('off');
          const audio = CommonUtils.$('#remoteAudio');
          if (audio) audio.volume = 0.3;
          CommonUtils.$('.video-container').style.filter = 'brightness(0.3)';
          CommonUtils.$('#proximityBtn').setAttribute('data-label', 'HoparlÃ¶r Modu');
        } else {
          CommonUtils.$('#videoBtn').classList.remove('off');
          const audio = CommonUtils.$('#remoteAudio');
          if (audio) audio.volume = 1.0;
          CommonUtils.$('.video-container').style.filter = 'none';
          CommonUtils.$('#proximityBtn').setAttribute('data-label', 'Ahize Modu');
        }
      }

      toggleFullscreen() {
        const container = CommonUtils.$('.video-container');
        if (!document.fullscreenElement) {
          container.requestFullscreen();
          CommonUtils.$('#fullscreenBtn').classList.add('active');
        } else {
          document.exitFullscreen();
          CommonUtils.$('#fullscreenBtn').classList.remove('active');
        }
      }

      startTimer() {
        this.callStartTime = Date.now();
        this.timerInterval = setInterval(() => {
          const elapsed = Math.floor((Date.now() - this.callStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          CommonUtils.$('#timer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
      }

      showCallScreen() {
        CommonUtils.$('#welcomeScreen').classList.add('hidden');
        CommonUtils.$('#timer').classList.remove('hidden');
      }

      showLoading(message) {
        CommonUtils.$('#loadingText').textContent = message;
        CommonUtils.$('#loadingOverlay').classList.remove('hidden');
      }

      hideLoading() {
        CommonUtils.$('#loadingOverlay').classList.add('hidden');
      }

      async endCall() {
        if (this.timerInterval) {
          clearInterval(this.timerInterval);
        }
        
        if (this.pc) {
          this.pc.close();
        }
        
        if (this.localStream) {
          this.localStream.getTracks().forEach(track => track.stop());
        }
        
        this.showWelcomeScreen();
      }

      showWelcomeScreen() {
        CommonUtils.$('#welcomeScreen').classList.remove('hidden');
        CommonUtils.$('#timer').classList.add('hidden');
        CommonUtils.$('#nameInput').value = '';
        CommonUtils.$('#startBtn').disabled = true;
      }
    }

    // Initialize Enhanced Quality Systems
    async function initializeEnhancedSystems() {
      try {
        if (window.AudioProcessor) {
          window.audioProcessor = new AudioProcessor();
          await window.audioProcessor.initialize();
        }
        
        if (window.AudioLevelManager) {
          window.audioLevelManager = new AudioLevelManager();
          await window.audioLevelManager.initialize();
        }

        if (window.VideoQualityManager) {
          window.videoQualityManager = new VideoQualityManager();
          await window.videoQualityManager.initialize();
        }

        if (window.NetworkMonitor) {
          window.networkMonitor = new NetworkMonitor();
          await window.networkMonitor.initialize();
        }

        if (window.MobileOptimizer) {
          window.mobileOptimizer = new MobileOptimizer();
          await window.mobileOptimizer.initialize();
        }

        if (window.BatteryOptimizer) {
          window.batteryOptimizer = new BatteryOptimizer();
          await window.batteryOptimizer.initialize();
        }

        console.log('[Index] Enhanced quality systems initialized');
      } catch (error) {
        console.error('[Index] Failed to initialize enhanced systems:', error);
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      initializeEnhancedSystems();
      window.customerCall = new CustomerCall();
    });
  </script>
</body>
</html>