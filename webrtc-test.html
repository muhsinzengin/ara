<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#0a0e1a" />
  <title>WebRTC GeliÅŸmiÅŸ Test (Mobil %100)</title>
  <style>
    :root {
      --bg:#0a0e1a; --card:#0f1629; --muted:#9aa4b2; --text:#e5e7eb; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --pri:#4CAF50;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:960px;margin:0 auto;padding:12px}
    .hdr{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(10,14,26,.98),rgba(10,14,26,.7));backdrop-filter:blur(8px);border-bottom:1px solid #1e293b}
    .hdr__in{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px 8px}
    .title{display:flex;align-items:center;gap:10px;font-weight:800}
    .title .em{font-size:22px}
    .actions{display:flex;gap:8px}
    button{border:0;border-radius:12px;padding:10px 12px;font-weight:700;color:#0b1020;background:#1f2a44}
    button.pri{background:linear-gradient(135deg,#4CAF50,#2e7d32);color:#fff}
    button.warn{background:#f59e0b;color:#111}
    button:disabled{opacity:.6}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:680px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;padding:14px}
    .card h3{margin:0 0 8px;font-size:16px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .kpi{background:#0b1328;border:1px solid #1e293b;border-radius:12px;padding:10px;text-align:center}
    .kpi .v{font-size:16px;font-weight:800}
    .kpi .l{font-size:11px;color:var(--muted)}
    .status{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .st{display:flex;align-items:center;gap:8px;background:#0b1328;border:1px solid #1e293b;border-radius:10px;padding:8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.err{background:var(--err)}
    .log{background:#050913;border:1px solid #132037;border-radius:12px;padding:10px;min-height:120px;max-height:260px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;line-height:1.4}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .badge{border:1px solid #1e293b;border-radius:999px;padding:4px 8px;color:var(--muted);font-size:11px}
    video{width:100%;max-height:240px;background:#000;border-radius:10px}
    .meter{height:10px;background:#0b1328;border:1px solid #1e293b;border-radius:999px;overflow:hidden}
    .meter>div{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444)}
    .help{font-size:12px;color:var(--muted)}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:10000;padding:16px}
    .overlay.show{display:flex}
    .ovbox{background:#fff;color:#111;padding:18px;border-radius:16px;max-width:560px;width:100%}
    .ovbox h4{margin:0 0 8px}
  </style>
</head>
<body>
  <div class="hdr">
    <div class="wrap hdr__in">
      <div class="title"><span class="em">ğŸ“±</span> WebRTC GeliÅŸmiÅŸ Test</div>
      <div class="actions">
        <button id="runAll" class="pri">TÃ¼m Testleri Ã‡alÄ±ÅŸtÄ±r</button>
        <button id="resetAll">SÄ±fÄ±rla</button>
        <button id="exportLog" class="warn">Logu DÄ±ÅŸa Aktar</button>
      </div>
    </div>
  </div>

  <div class="wrap" style="margin-top:10px">
    <div class="grid">
      <div class="card">
        <h3>Durum Ã–zeti</h3>
        <div class="status" id="statusGrid">
          <div class="st"><span class="dot" id="stSecure"></span><span>GÃ¼venli BaÄŸlam</span></div>
          <div class="st"><span class="dot" id="stGUM"></span><span>getUserMedia</span></div>
          <div class="st"><span class="dot" id="stPC"></span><span>RTCPeerConnection</span></div>
          <div class="st"><span class="dot" id="stPerm"></span><span>Ä°zinler (Kamera/Mikrofon)</span></div>
          <div class="st"><span class="dot" id="stDevices"></span><span>Cihaz SayÄ±mÄ±</span></div>
          <div class="st"><span class="dot" id="stCamera"></span><span>Kamera Testi</span></div>
          <div class="st"><span class="dot" id="stMic"></span><span>Mikrofon Testi</span></div>
          <div class="st"><span class="dot" id="stRTC"></span><span>RTC Loopback</span></div>
          <div class="st"><span class="dot" id="stAPI"></span><span>API Health</span></div>
        </div>
        <div style="margin-top:10px" class="row">
          <span class="badge" id="ua"></span>
          <span class="badge" id="plat"></span>
          <span class="badge" id="net"></span>
          <span class="badge" id="mem"></span>
        </div>
      </div>

      <div class="card">
        <h3>Loglar</h3>
        <div class="row" style="margin-bottom:6px">
          <button id="fltAll">TÃ¼mÃ¼</button>
          <button id="fltWarn">UyarÄ±</button>
          <button id="fltErr">Hata</button>
          <span class="help">Ä°puÃ§larÄ± ve hatalar burada toplanÄ±r.</span>
        </div>
        <div class="log" id="log"></div>
      </div>

      <div class="card">
        <h3>Ä°zinler</h3>
        <div class="row" style="gap:6px;margin-bottom:8px">
          <button id="btnRePerm" class="pri">Ä°zinleri Yeniden Ä°ste</button>
          <button id="btnHelp">Ä°zin YardÄ±mÄ±</button>
        </div>
        <div class="row">
          <span class="badge" id="permCam">Kamera: -</span>
          <span class="badge" id="permMic">Mikrofon: -</span>
          <span class="badge" id="secureCtx">HTTPS/Localhost: -</span>
        </div>
      </div>

      <div class="card">
        <h3>Cihazlar</h3>
        <div class="row">
          <span class="badge" id="camCount">Kamera: -</span>
          <span class="badge" id="micCount">Mikrofon: -</span>
          <span class="badge" id="spkCount">HoparlÃ¶r: -</span>
        </div>
      </div>

      <div class="card">
        <h3>Kamera</h3>
        <video id="video" playsinline muted></video>
        <div class="row" style="margin-top:8px">
          <button id="startCam" class="pri">KamerayÄ± BaÅŸlat</button>
          <button id="stopCam">KamerayÄ± Durdur</button>
          <span class="badge" id="vidInfo">-</span>
        </div>
      </div>

      <div class="card">
        <h3>Mikrofon</h3>
        <div class="meter"><div id="micLevel"></div></div>
        <div class="row" style="margin-top:8px">
          <button id="startMic" class="pri">Mikrofonu BaÅŸlat</button>
          <button id="stopMic">Mikrofonu Durdur</button>
          <span class="badge" id="micInfo">-</span>
        </div>
      </div>

      <div class="card">
        <h3>HoparlÃ¶r</h3>
        <div class="row" style="gap:6px;margin-bottom:8px">
          <select id="speakerSelect" style="flex:1;min-width:160px"></select>
          <button id="testSpeaker" class="pri">HoparlÃ¶rÃ¼ Test Et</button>
        </div>
        <div class="help">Not: Ã‡Ä±kÄ±ÅŸ cihazÄ± deÄŸiÅŸtirme (setSinkId) yalnÄ±zca HTTPS ya da localhost ortamÄ±nda ve destekleyen tarayÄ±cÄ±larda Ã§alÄ±ÅŸÄ±r.</div>
        <audio id="testTone" preload="auto" style="display:none"></audio>
      </div>

      <div class="card">
        <h3>RTC Loopback (Yerel)</h3>
        <div class="row" style="margin-bottom:6px">
          <button id="runRTC" class="pri">Loopback Testi</button>
          <button id="stopRTC">Durdur</button>
        </div>
        <div class="row">
          <span class="badge" id="rtcState">-</span>
          <span class="badge" id="rtcIce">ICE: -</span>
          <span class="badge" id="rtcRtt">RTT: -</span>
        </div>
        <div class="help">Not: Yerel loopback NAT/TURN doÄŸrulamaz; temel WebRTC yÄ±ÄŸÄ±nÄ±nÄ± test eder.</div>
      </div>

      <div class="card">
        <h3>API SaÄŸlÄ±k</h3>
        <div class="row" style="margin-bottom:6px"><button id="runHealth" class="pri">/api/healthz Test</button></div>
        <div class="row">
          <span class="badge" id="apiUptime">Uptime: -</span>
          <span class="badge" id="apiCounts">OTP/Session/Call: -</span>
          <span class="badge" id="apiVer">Versiyon: -</span>
        </div>
      </div>

      <div class="card">
        <h3>Cihaz/Performans</h3>
        <div class="row">
          <span class="badge" id="bat">Batarya: -</span>
          <span class="badge" id="memJS">JS Heap: -</span>
        </div>
      </div>
    </div>
  </div>

  <div id="permOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="permTitle">
    <div class="ovbox">
      <h4 id="permTitle">Ä°zinler Gerekli</h4>
      <p><strong>Neden?</strong> TarayÄ±cÄ± kamera/mikrofon izinlerini reddetmiÅŸ gÃ¶rÃ¼nÃ¼yor.</p>
      <p>1) Adres Ã§ubuÄŸundaki kilit simgesine tÄ±klayÄ±n ve Kamera/Mikrofon iÃ§in "Ä°zin ver" seÃ§in.</p>
      <p>2) SayfayÄ± yenileyin veya aÅŸaÄŸÄ±daki "Ä°zinleri Yeniden Ä°ste" butonuna tÄ±klayÄ±n.</p>
      <p>3) Mobil: Android Chrome â†’ Ayarlar â†’ Site Ä°zinleri â†’ Kamera/Mikrofon. iOS Safari â†’ Ayarlar â†’ Safari â†’ Kamera/Mikrofon.</p>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="ovReq" class="pri">Ä°zinleri Yeniden Ä°ste</button>
        <button id="ovClose">Kapat</button>
      </div>
    </div>
  </div>

  <script>
  // === State / Utils ===
  const logEl = document.getElementById('log');
  const logs = [];
  let logFilter = 'all';
  function log(level, msg){
    const ts = new Date().toISOString();
    const entry = {ts, level, msg};
    logs.push(entry);
    if (logFilter === 'all' || (logFilter==='warn' && level!=='info') || (logFilter==='err' && level==='err')){
      const line = document.createElement('div');
      line.textContent = `[${ts}] [${level.toUpperCase()}] ${msg}`;
      line.style.color = level==='err' ? '#ef4444' : (level==='warn'? '#f59e0b' : '#e5e7eb');
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }
    console.log('webrtc-test:', level, msg);
  }
  function setDot(id, state){
    const el = document.getElementById(id);
    if (!el) return;
    el.className = 'dot ' + (state==='ok' ? 'ok' : state==='warn' ? 'warn' : 'err');
  }
  function setBadge(id, text){ const el=document.getElementById(id); if(el) el.textContent = text; }

  // Env badges
  (function initEnv(){
    setBadge('ua', navigator.userAgent.split(')')[0].slice(0,48)+'...)');
    setBadge('plat', 'Platform: ' + (navigator.platform||'-'));
    const c = navigator.connection || navigator.webkitConnection || {};
    setBadge('net', 'AÄŸ: ' + (c.effectiveType||'bilinmiyor'));
    if (navigator.deviceMemory) setBadge('mem', 'Bellek: '+navigator.deviceMemory+'GB');
  })();

  // Global media/rtc holders
  let camStream = null;
  let micStream = null;
  let pc1=null, pc2=null, rtcStatsInterval=null, statsInterval=null;
  let speakerDevices = [];

  // === Tests ===
  function checkSecure(){
    const secure = location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1';
    setDot('stSecure', secure?'ok':'err');
    setBadge('secureCtx', 'HTTPS/Localhost: ' + (secure?'evet':'hayÄ±r'));
    if(!secure) log('warn','GÃ¼venli baÄŸlam deÄŸil. Kamera/Mikrofon engellenebilir.');
    return secure;
  }

  function checkAPIs(){
    const gum = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
    const pc = !!window.RTCPeerConnection;
    setDot('stGUM', gum?'ok':'err');
    setDot('stPC', pc?'ok':'err');
    if(!gum) log('err','getUserMedia desteklenmiyor');
    if(!pc) log('err','RTCPeerConnection desteklenmiyor');
    return gum && pc;
  }

  async function checkPermissions(){
    try{
      if (!navigator.permissions){
        setBadge('permCam','Kamera: bilinmiyor');
        setBadge('permMic','Mikrofon: bilinmiyor');
        setDot('stPerm','warn');
        log('warn','Permissions API yok, durum bilinmiyor');
        return;
      }
      const cam = await navigator.permissions.query({name:'camera'}).catch(()=>({state:'prompt'}));
      const mic = await navigator.permissions.query({name:'microphone'}).catch(()=>({state:'prompt'}));
      setBadge('permCam','Kamera: '+cam.state);
      setBadge('permMic','Mikrofon: '+mic.state);
      const ok = (cam.state==='granted' && mic.state==='granted');
      setDot('stPerm', ok? 'ok' : (cam.state==='denied'||mic.state==='denied')? 'err':'warn');
      if(!ok) log('warn','Ä°zinler tam deÄŸil (camera='+cam.state+', mic='+mic.state+')');
    }catch(e){ log('err','Ä°zin kontrol hatasÄ±: '+e.message); setDot('stPerm','err'); }
  }

  async function listDevices(){
    try{
      const devs = await navigator.mediaDevices.enumerateDevices();
      const cams = devs.filter(d=>d.kind==='videoinput');
      const mics = devs.filter(d=>d.kind==='audioinput');
      const spks = devs.filter(d=>d.kind==='audiooutput');
      setBadge('camCount','Kamera: '+cams.length);
      setBadge('micCount','Mikrofon: '+mics.length);
      setBadge('spkCount','HoparlÃ¶r: '+spks.length);
      setDot('stDevices', (cams.length+mics.length)>0? 'ok':'warn');
      if(cams.length===0) log('warn','Kamera bulunamadÄ±');
      if(mics.length===0) log('warn','Mikrofon bulunamadÄ±');

      // Populate speaker select
      speakerDevices = spks;
      const sel = document.getElementById('speakerSelect');
      if (sel) {
        sel.innerHTML = spks.map((d,i)=>`<option value="${d.deviceId}">${d.label || ('HoparlÃ¶r '+(i+1))}</option>`).join('');
      }
    }catch(e){ setDot('stDevices','err'); log('err','Cihaz listeleme hatasÄ±: '+e.message); }
  }

  async function startCamera(){
    try{
      camStream = await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720},facingMode:'user'}, audio:false});
      const v = document.getElementById('video');
      v.srcObject = camStream; await v.play().catch(()=>{});
      await new Promise(r=>setTimeout(r,300));
      document.getElementById('vidInfo').textContent = `GerÃ§ek Ã§Ã¶zÃ¼nÃ¼rlÃ¼k: ${v.videoWidth}x${v.videoHeight}`;
      setDot('stCamera','ok');
      log('info',`Kamera baÅŸladÄ±: ${v.videoWidth}x${v.videoHeight}`);
    }catch(e){
      setDot('stCamera','err');
      const map = {NotAllowedError:'Ä°zin reddedildi', NotFoundError:'Kamera bulunamadÄ±', NotReadableError:'Cihaza eriÅŸilemiyor', OverconstrainedError:'KÄ±sÄ±tlar saÄŸlanamadÄ±'};
      log('err','Kamera hatasÄ±: '+(map[e.name]||e.name||e.message));
      showPermOverlayIfDenied(e);
    }
  }
  function stopCamera(){ if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; document.getElementById('video').srcObject=null; document.getElementById('vidInfo').textContent='-'; } }

  // Mic level via WebAudio
  let audioCtx=null, analyser=null, micLevelTimer=null;
  async function startMic(){
    try{
      micStream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true}, video:false});
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const src = audioCtx.createMediaStreamSource(micStream);
      analyser = audioCtx.createAnalyser(); analyser.fftSize=512; src.connect(analyser);
      const buf = new Uint8Array(analyser.frequencyBinCount);
      const bar = document.getElementById('micLevel');
      micLevelTimer = setInterval(()=>{
        analyser.getByteTimeDomainData(buf);
        // rough RMS
        let sum=0; for(let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; sum+=v*v;}
        const rms = Math.sqrt(sum/buf.length); const pct = Math.min(100, Math.max(0, Math.round(rms*200)));
        bar.style.width = pct+'%';
      }, 100);
      setDot('stMic','ok'); setBadge('micInfo','Aktif'); log('info','Mikrofon baÅŸladÄ±');
    }catch(e){ setDot('stMic','err'); log('err','Mikrofon hatasÄ±: '+(e.name||e.message)); showPermOverlayIfDenied(e); }
  }
  function stopMic(){ if(micStream){ micStream.getTracks().forEach(t=>t.stop()); micStream=null; } if(micLevelTimer){ clearInterval(micLevelTimer); micLevelTimer=null; } if(audioCtx){ audioCtx.close(); audioCtx=null; } document.getElementById('micLevel').style.width='0%'; setBadge('micInfo','-'); }

  // Loopback RTC
  async function runLoopback(){
    try{
      if(!window.RTCPeerConnection){ setDot('stRTC','err'); return; }
      pc1 = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
      pc2 = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
      let iceTypes = new Set();
      pc1.onicecandidate = e=>{ if(e.candidate){ iceTypes.add(e.candidate.type); pc2.addIceCandidate(e.candidate); }};
      pc2.onicecandidate = e=>{ if(e.candidate){ iceTypes.add(e.candidate.type); pc1.addIceCandidate(e.candidate); }};
      const s = camStream || await navigator.mediaDevices.getUserMedia({video:false,audio:true});
      s.getTracks().forEach(t=>pc1.addTrack(t, s));
      const offer = await pc1.createOffer(); await pc1.setLocalDescription(offer); await pc2.setRemoteDescription(offer);
      const answer = await pc2.createAnswer(); await pc2.setLocalDescription(answer); await pc1.setRemoteDescription(answer);
      setBadge('rtcState','BaÄŸlanÄ±yor...');
      const start = performance.now();
      await new Promise((res,rej)=>{
        const to = setTimeout(()=>rej(new Error('Zaman aÅŸÄ±mÄ±')), 8000);
        const chk = setInterval(()=>{
          if(pc1.connectionState==='connected' && pc2.connectionState==='connected'){ clearTimeout(to); clearInterval(chk); res(); }
        }, 100);
      });
      setDot('stRTC','ok');
      setBadge('rtcState','BaÄŸlandÄ± ~'+Math.round(performance.now()-start)+'ms');
      setBadge('rtcIce','ICE: '+Array.from(iceTypes).join(','));
      rtcStatsInterval = setInterval(async()=>{
        try{
          const stats = await pc1.getStats(); let rtt=null;
          stats.forEach(r=>{ if(r.type==='candidate-pair' && r.state==='succeeded'){ rtt = r.currentRoundTripTime; }});
          if(rtt!=null) setBadge('rtcRtt','RTT: '+Math.round(rtt*1000)+'ms');
        }catch{}
      }, 1000);
      log('info','Loopback baÅŸarÄ±lÄ±');
    }catch(e){ setDot('stRTC','err'); setBadge('rtcState','Hata'); log('err','Loopback hatasÄ±: '+e.message); }
  }
  function stopLoopback(){ if(rtcStatsInterval){ clearInterval(rtcStatsInterval); rtcStatsInterval=null; } if(pc1){ pc1.close(); pc1=null;} if(pc2){ pc2.close(); pc2=null;} setBadge('rtcState','-'); setBadge('rtcIce','ICE: -'); setBadge('rtcRtt','RTT: -'); }

  async function health(){
    try{
      const r = await fetch('/api/healthz');
      if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      setDot('stAPI','ok');
      setBadge('apiUptime','Uptime: '+(j.uptime ?? '-'));
      setBadge('apiCounts',`OTP/Session/Call: ${j.active_otps}/${j.active_sessions}/${j.active_calls}`);
      setBadge('apiVer','Versiyon: '+(j.version||'-'));
      log('info','API saÄŸlÄ±k OK');
    }catch(e){ setDot('stAPI','err'); log('err','API saÄŸlÄ±k hatasÄ±: '+e.message); }
  }

  // Perf extras
  (function perf(){
    if('getBattery' in navigator){ navigator.getBattery().then(b=>{ setBadge('bat', `Batarya: ${Math.round(b.level*100)}% ${b.charging?'(Åarj)':''}`); }); }
    if(performance && performance.memory){ const m=performance.memory; setBadge('memJS', 'JS Heap: '+Math.round(m.usedJSHeapSize/1048576)+'MB'); }
  })();

  // Overlay helpers
  function openOverlay(){ document.getElementById('permOverlay').classList.add('show'); }
  function closeOverlay(){ document.getElementById('permOverlay').classList.remove('show'); }
  function showPermOverlayIfDenied(e){ if(e && (e.name==='NotAllowedError' || e.name==='SecurityError')) openOverlay(); }

  // Run All sequence
  async function runAll(){
    logEl.innerHTML='';
    checkSecure();
    if(!checkAPIs()) return;
    await checkPermissions();
    await listDevices();
    await startCamera();
    await startMic();
    await runLoopback();
    await health();
    log('info','TÃ¼m testler tamamlandÄ±');
  }

  // Reset everything
  function resetAll(){ stopCamera(); stopMic(); stopLoopback(); log('info','SÄ±fÄ±rlandÄ±'); }

  // Bindings
  document.getElementById('runAll').onclick = runAll;
  document.getElementById('resetAll').onclick = resetAll;
  document.getElementById('exportLog').onclick = ()=>{
    const blob = new Blob([JSON.stringify(logs,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='webrtc-test-log.json'; a.click();
  };
  document.getElementById('btnRePerm').onclick = reRequestPerm;
  document.getElementById('ovReq').onclick = reRequestPerm;
  document.getElementById('ovClose').onclick = closeOverlay;
  document.getElementById('btnHelp').onclick = openOverlay;
  document.getElementById('startCam').onclick = startCamera;
  document.getElementById('stopCam').onclick = stopCamera;
  document.getElementById('startMic').onclick = startMic;
  document.getElementById('stopMic').onclick = stopMic;
  document.getElementById('runRTC').onclick = runLoopback;
  document.getElementById('stopRTC').onclick = stopLoopback;
  document.getElementById('runHealth').onclick = health;
  document.getElementById('testSpeaker').onclick = testSpeaker;
  document.getElementById('fltAll').onclick = ()=>{ logFilter='all'; logEl.innerHTML=''; logs.forEach(l=>log(l.level,l.msg)); };
  document.getElementById('fltWarn').onclick = ()=>{ logFilter='warn'; logEl.innerHTML=''; logs.filter(l=>l.level!=='info').forEach(l=>log(l.level,l.msg)); };
  document.getElementById('fltErr').onclick = ()=>{ logFilter='err'; logEl.innerHTML=''; logs.filter(l=>l.level==='err').forEach(l=>log(l.level,l.msg)); };

  async function reRequestPerm(){
    try{
      const s = await navigator.mediaDevices.getUserMedia({audio:true,video:true});
      s.getTracks().forEach(t=>t.stop());
      log('info','Ä°zin tekrar alÄ±ndÄ±'); closeOverlay(); checkPermissions();
    }catch(e){ log('err','Ä°zin tekrar alÄ±namadÄ±: '+(e.name||e.message)); openOverlay(); }
  }

  function supportsSetSinkId(){
    const a = document.createElement('audio');
    return typeof a.setSinkId === 'function';
  }

  async function setSpeakerDevice(deviceId){
    const audio = document.getElementById('testTone');
    if (!audio) return false;
    if (!supportsSetSinkId()) { log('warn','TarayÄ±cÄ± setSinkId desteklemiyor'); return false; }
    try {
      await audio.setSinkId(deviceId);
      log('info','Ã‡Ä±kÄ±ÅŸ cihazÄ± ayarlandÄ±');
      return true;
    } catch (e) {
      log('err','HoparlÃ¶r cihaz ayarÄ± baÅŸarÄ±sÄ±z: '+(e.name||e.message));
      return false;
    }
  }

  async function testSpeaker(){
    try{
      // Ensure user gesture context; this handler runs on click
      const audio = document.getElementById('testTone');
      if (!audio) return;
      const sel = document.getElementById('speakerSelect');
      if (sel && sel.value) await setSpeakerDevice(sel.value);
      // 440Hz kÄ±sa bip (WAV data URI)
      audio.src = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAAAAAD4////+P///vj///z9///8/f///P3///z9///8/f///P3///z9///8/f///P3///z9///8/f///P3///z9///8/f8=';
      await audio.play();
      log('info','HoparlÃ¶r test sesi Ã§alÄ±yor');
    }catch(e){
      log('err','HoparlÃ¶r testi baÅŸarÄ±sÄ±z: '+(e.name||e.message));
    }
  }

  // Initial checks
  checkSecure(); checkAPIs(); checkPermissions(); listDevices();
  </script>
</body>
</html>
